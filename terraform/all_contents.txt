=== all_tf_with_names.txt ===
=== ./security-groups.tf ===
# Bastion Security Group
resource "yandex_vpc_security_group" "bastion_sg" {
  name        = "bastion-security-group"
  description = "Security group for bastion host"  
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "SSH from anywhere"
    protocol       = "TCP"
    port           = 22
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Web Servers Security Group
resource "yandex_vpc_security_group" "web_sg" {
  name        = "web-security-group"
  description = "Security group for web servers"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "HTTP from Load Balancer"
    protocol       = "TCP"
    port           = 80
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    description    = "Node Exporter from Prometheus"
    protocol       = "TCP"
    port           = 9100
    security_group_id = yandex_vpc_security_group.prometheus_sg.id
  }

  ingress {
    description    = "Nginx Log Exporter from Prometheus"
    protocol       = "TCP"
    port           = 4040
    security_group_id = yandex_vpc_security_group.prometheus_sg.id
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  # УДАЛИТЕ этот ingress - web серверы НЕ должны принимать входящие подключения на 9200
  # Вместо этого добавьте egress для исходящих подключений
  # ingress {
  #   description    = "Filebeat to Elasticsearch"
  #   protocol       = "TCP"
  #   port           = 9200
  #   security_group_id = yandex_vpc_security_group.elasticsearch_sg.id
  # }

  egress {
    description    = "Filebeat to Elasticsearch"
    protocol       = "TCP"
    port           = 9200
    v4_cidr_blocks = [var.private_subnet_cidr_a]
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Prometheus Security Group
resource "yandex_vpc_security_group" "prometheus_sg" {
  name        = "prometheus-security-group"
  description = "Security group for Prometheus"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Prometheus UI from Grafana"
    protocol       = "TCP"
    port           = 9090
    security_group_id = yandex_vpc_security_group.grafana_sg.id
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Grafana Security Group
resource "yandex_vpc_security_group" "grafana_sg" {
  name        = "grafana-security-group"
  description = "Security group for Grafana"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Grafana UI from anywhere"
    protocol       = "TCP"
    port           = 3000
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Elasticsearch Security Group
resource "yandex_vpc_security_group" "elasticsearch_sg" {
  name        = "elasticsearch-security-group"
  description = "Security group for Elasticsearch"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Elasticsearch API from Kibana"
    protocol       = "TCP"
    port           = 9200
    security_group_id = yandex_vpc_security_group.kibana_sg.id
  }

  # ИЗМЕНИТЕ: вместо security_group_id используйте v4_cidr_blocks
  ingress {
    description    = "Filebeat from Web Servers"
    protocol       = "TCP"
    port           = 9200
    v4_cidr_blocks = [var.private_subnet_cidr_a, var.private_subnet_cidr_b]
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Kibana Security Group
resource "yandex_vpc_security_group" "kibana_sg" {
  name        = "kibana-security-group"
  description = "Security group for Kibana"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Kibana UI from anywhere"
    protocol       = "TCP"
    port           = 5601
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Load Balancer Security Group
resource "yandex_vpc_security_group" "lb_sg" {
  name        = "load-balancer-security-group"
  description = "Security group for Load Balancer"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "HTTP from anywhere"
    protocol       = "TCP"
    port           = 80
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}
=== ./lb.tf ===
# Target Group for web servers
resource "yandex_lb_target_group" "web" {
  name = "web-target-group"

  target {
    subnet_id  = yandex_vpc_subnet.private_a.id
    address    = yandex_compute_instance.web_1.network_interface.0.ip_address
  }

  target {
    subnet_id  = yandex_vpc_subnet.private_b.id
    address    = yandex_compute_instance.web_2.network_interface.0.ip_address
  }
}

# Network Load Balancer
resource "yandex_lb_network_load_balancer" "web_nlb" {
  name = "web-network-load-balancer"
  type = "external"

  listener {
    name = "web-listener"
    port = 80
    external_address_spec {
      ip_version = "ipv4"
    }
  }

  attached_target_group {
    target_group_id = yandex_lb_target_group.web.id

    healthcheck {
      name                = "http"
      interval            = 2
      timeout             = 1
      unhealthy_threshold = 2
      healthy_threshold   = 2

      http_options {
        port = 80
        path = "/"
      }
    }
  }
}
=== ./outputs.tf ===
output "bastion_public_ip" {
  value       = yandex_compute_instance.bastion.network_interface[0].nat_ip_address
  description = "Public IP address of bastion host"
}

output "load_balancer_ip" {
  value = one([
    for spec in one(yandex_lb_network_load_balancer.web_nlb.listener).external_address_spec : spec.address
  ])
  description = "Public IP address of Network Load Balancer"
}

output "grafana_public_ip" {
  value       = yandex_compute_instance.grafana.network_interface[0].nat_ip_address
  description = "Public IP address of Grafana"
}

output "kibana_public_ip" {
  value       = yandex_compute_instance.kibana.network_interface[0].nat_ip_address
  description = "Public IP address of Kibana"
}

output "web_servers_private_ips" {
  value = {
    web_1 = yandex_compute_instance.web_1.network_interface[0].ip_address
    web_2 = yandex_compute_instance.web_2.network_interface[0].ip_address
  }
  description = "Private IP addresses of web servers"
}

output "prometheus_private_ip" {
  value       = yandex_compute_instance.prometheus.network_interface[0].ip_address
  description = "Private IP address of Prometheus"
}

output "elasticsearch_private_ip" {
  value       = yandex_compute_instance.elasticsearch.network_interface[0].ip_address
  description = "Private IP address of Elasticsearch"
}
=== ./variables.tf ===
variable "yc_token" {
  type      = string
  sensitive = true
  description = "Yandex Cloud OAuth token"
}

variable "yc_cloud_id" {
  type        = string
  description = "Yandex Cloud ID"
}

variable "yc_folder_id" {
  type        = string
  description = "Yandex Cloud folder ID"
}

variable "ssh_public_key_path" {
  type        = string
  default     = "~/.ssh/id_rsa.pub"
  description = "Path to SSH public key"
}

variable "ubuntu_image_id" {
  type        = string
  default     = "fd804teg9bthv0h96s8v"
  description = "Ubuntu 22.04 LTS image ID"
}

# Network variables
variable "vpc_cidr" {
  type        = string
  default     = "10.0.0.0/16"
  description = "VPC CIDR block"
}

variable "public_subnet_cidr" {
  type        = string
  default     = "10.0.1.0/24"
  description = "Public subnet CIDR"
}

variable "private_subnet_cidr_a" {
  type        = string
  default     = "10.0.2.0/24"
  description = "Private subnet A CIDR"
}

variable "private_subnet_cidr_b" {
  type        = string
  default     = "10.0.3.0/24"
  description = "Private subnet B CIDR"
}

# Instance names
variable "bastion_name" {
  type        = string
  default     = "bastion"
  description = "Bastion host name"
}

variable "webserver_names" {
  type        = list(string)
  default     = ["web-1", "web-2"]
  description = "Web server names"
}

variable "prometheus_name" {
  type        = string
  default     = "prometheus"
  description = "Prometheus server name"
}

variable "grafana_name" {
  type        = string
  default     = "grafana"
  description = "Grafana server name"
}

variable "elasticsearch_name" {
  type        = string
  default     = "elasticsearch"
  description = "Elasticsearch server name"
}

variable "kibana_name" {
  type        = string
  default     = "kibana"
  description = "Kibana server name"
}

# Instance types
variable "bastion_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Bastion instance type"
}

variable "web_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Web server instance type"
}

variable "prometheus_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Prometheus instance type"
}

variable "grafana_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Grafana instance type"
}

variable "elasticsearch_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Elasticsearch instance type"
}

variable "kibana_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Kibana instance type"
}
=== ./vpc.tf ===
# VPC
resource "yandex_vpc_network" "main" {
  name = "infra-project-vpc"
}

# Public subnet
resource "yandex_vpc_subnet" "public" {
  name           = "public-subnet"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main.id
  v4_cidr_blocks = [var.public_subnet_cidr]
}

# Private subnet A
resource "yandex_vpc_subnet" "private_a" {
  name           = "private-subnet-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main.id
  v4_cidr_blocks = [var.private_subnet_cidr_a]
  route_table_id = yandex_vpc_route_table.nat.id
}

# Private subnet B
resource "yandex_vpc_subnet" "private_b" {
  name           = "private-subnet-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.main.id
  v4_cidr_blocks = [var.private_subnet_cidr_b]
  route_table_id = yandex_vpc_route_table.nat.id
}

# NAT Gateway
resource "yandex_vpc_gateway" "nat_gateway" {
  name = "nat-gateway"
  shared_egress_gateway {}
}

# Route table for NAT
resource "yandex_vpc_route_table" "nat" {
  name       = "nat-route-table"
  network_id = yandex_vpc_network.main.id

  static_route {
    destination_prefix = "0.0.0.0/0"
    gateway_id         = yandex_vpc_gateway.nat_gateway.id
  }
}
=== ./main.tf ===
terraform {
  required_version = ">= 1.0"
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = ">= 0.89"
    }
  }
}

provider "yandex" {
  token     = var.yc_token
  cloud_id  = var.yc_cloud_id
  folder_id = var.yc_folder_id
  zone      = "ru-central1-a"
}
=== ./compute.tf ===
# Bastion Host
resource "yandex_compute_instance" "bastion" {
  name        = var.bastion_name
  platform_id = var.bastion_instance_type
  zone        = "ru-central1-a"
  hostname    = var.bastion_name

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.public.id
    nat       = true
    security_group_ids = [yandex_vpc_security_group.bastion_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
    user-data = <<-EOF
      #cloud-config
      write_files:
        - path: /etc/sysctl.d/10-ip-forward.conf
          content: |
            net.ipv4.ip_forward=1
            net.ipv6.conf.all.forwarding=1
      runcmd:
        - sysctl -p /etc/sysctl.d/10-ip-forward.conf
        - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        - iptables -A FORWARD -i eth0 -o eth0 -j ACCEPT
        - apt-get update
        - apt-get install -y iptables-persistent
        - netfilter-persistent save
      EOF
  }
}

# Web Server 1
resource "yandex_compute_instance" "web_1" {
  name        = var.webserver_names[0]
  platform_id = var.web_instance_type
  zone        = "ru-central1-a"
  hostname    = var.webserver_names[0]

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_a.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.web_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Web Server 2
resource "yandex_compute_instance" "web_2" {
  name        = var.webserver_names[1]
  platform_id = var.web_instance_type
  zone        = "ru-central1-b"
  hostname    = var.webserver_names[1]

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_b.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.web_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Prometheus Server
resource "yandex_compute_instance" "prometheus" {
  name        = var.prometheus_name
  platform_id = var.prometheus_instance_type
  zone        = "ru-central1-a"
  hostname    = var.prometheus_name

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_a.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.prometheus_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Grafana Server
resource "yandex_compute_instance" "grafana" {
  name        = var.grafana_name
  platform_id = var.grafana_instance_type
  zone        = "ru-central1-a"
  hostname    = var.grafana_name

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.public.id
    nat       = true
    security_group_ids = [yandex_vpc_security_group.grafana_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Elasticsearch Server
resource "yandex_compute_instance" "elasticsearch" {
  name        = var.elasticsearch_name
  platform_id = var.elasticsearch_instance_type
  zone        = "ru-central1-a"
  hostname    = var.elasticsearch_name

  resources {
    cores  = 4
    memory = 8
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 30
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_a.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.elasticsearch_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Kibana Server
resource "yandex_compute_instance" "kibana" {
  name        = var.kibana_name
  platform_id = var.kibana_instance_type
  zone        = "ru-central1-a"
  hostname    = var.kibana_name

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.public.id
    nat       = true
    security_group_ids = [yandex_vpc_security_group.kibana_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}
=== ./backup.tf ===
# Snapshot schedule for all instances
resource "yandex_compute_snapshot_schedule" "daily_backup" {
  name = "daily-backup-schedule"

  schedule_policy {
    expression = "0 2 * * *" # Daily at 02:00
  }

  retention_period = "168h" # 7 days in hours

  snapshot_count = 7 # Keep 7 snapshots

  snapshot_spec {
    description = "Daily backup"
  }

  # Attach all instance disks
  disk_ids = [
    yandex_compute_instance.bastion.boot_disk[0].disk_id,
    yandex_compute_instance.web_1.boot_disk[0].disk_id,
    yandex_compute_instance.web_2.boot_disk[0].disk_id,
    yandex_compute_instance.prometheus.boot_disk[0].disk_id,
    yandex_compute_instance.grafana.boot_disk[0].disk_id,
    yandex_compute_instance.elasticsearch.boot_disk[0].disk_id,
    yandex_compute_instance.kibana.boot_disk[0].disk_id,
  ]
}

=== backup.tf ===
# Snapshot schedule for all instances
resource "yandex_compute_snapshot_schedule" "daily_backup" {
  name = "daily-backup-schedule"

  schedule_policy {
    expression = "0 2 * * *" # Daily at 02:00
  }

  retention_period = "168h" # 7 days in hours

  snapshot_count = 7 # Keep 7 snapshots

  snapshot_spec {
    description = "Daily backup"
  }

  # Attach all instance disks
  disk_ids = [
    yandex_compute_instance.bastion.boot_disk[0].disk_id,
    yandex_compute_instance.web_1.boot_disk[0].disk_id,
    yandex_compute_instance.web_2.boot_disk[0].disk_id,
    yandex_compute_instance.prometheus.boot_disk[0].disk_id,
    yandex_compute_instance.grafana.boot_disk[0].disk_id,
    yandex_compute_instance.elasticsearch.boot_disk[0].disk_id,
    yandex_compute_instance.kibana.boot_disk[0].disk_id,
  ]
}

=== compute.tf ===
# compute.tf

# Bastion Host - обычный инстанс, полная производительность
resource "yandex_compute_instance" "bastion" {
  name        = var.bastion_name
  platform_id = var.bastion_instance_type
  zone        = "ru-central1-a"
  hostname    = var.bastion_name

  resources {
    cores         = 2
    core_fraction = var.bastion_core_fraction  # 100% по умолчанию
    memory        = 2
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.public.id
    nat       = true
    security_group_ids = [yandex_vpc_security_group.bastion_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
    user-data = <<-EOF
      #cloud-config
      write_files:
        - path: /etc/sysctl.d/10-ip-forward.conf
          content: |
            net.ipv4.ip_forward=1
            net.ipv6.conf.all.forwarding=1
      runcmd:
        - sysctl -p /etc/sysctl.d/10-ip-forward.conf
        - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        - iptables -A FORWARD -i eth0 -o eth0 -j ACCEPT
        - apt-get update
        - apt-get install -y iptables-persistent
        - netfilter-persistent save
      EOF
  }
}

# Web Server 1 - прерываемый с минимальной долей vCPU
resource "yandex_compute_instance" "web_1" {
  name        = var.webserver_names[0]
  platform_id = var.web_instance_type
  zone        = "ru-central1-a"
  hostname    = var.webserver_names[0]

  resources {
    cores         = 2
    core_fraction = var.web_core_fraction  # 5% минимальная доля
    memory        = 2
  }

  scheduling_policy {
    preemptible = var.web_preemptible  # true - прерываемый
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_a.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.web_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Web Server 2 - прерываемый с минимальной долей vCPU
resource "yandex_compute_instance" "web_2" {
  name        = var.webserver_names[1]
  platform_id = var.web_instance_type
  zone        = "ru-central1-b"
  hostname    = var.webserver_names[1]

  resources {
    cores         = 2
    core_fraction = var.web_core_fraction  # 5% минимальная доля
    memory        = 2
  }

  scheduling_policy {
    preemptible = var.web_preemptible  # true - прерываемый
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_b.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.web_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Prometheus Server - обычный, средняя производительность
resource "yandex_compute_instance" "prometheus" {
  name        = var.prometheus_name
  platform_id = var.prometheus_instance_type
  zone        = "ru-central1-a"
  hostname    = var.prometheus_name

  resources {
    cores         = 2
    core_fraction = var.prometheus_core_fraction  # 50% средняя производительность
    memory        = 2
  }

  # Prometheus не делаем прерываемым, так как это критично для мониторинга
  scheduling_policy {
    preemptible = var.prometheus_preemptible  # false
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_a.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.prometheus_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Grafana Server - обычный, базовая производительность
resource "yandex_compute_instance" "grafana" {
  name        = var.grafana_name
  platform_id = var.grafana_instance_type
  zone        = "ru-central1-a"
  hostname    = var.grafana_name

  resources {
    cores         = 2
    core_fraction = var.grafana_core_fraction  # 20% базовая производительность
    memory        = 2
  }

  scheduling_policy {
    preemptible = var.grafana_preemptible  # false
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.public.id
    nat       = true
    security_group_ids = [yandex_vpc_security_group.grafana_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Elasticsearch Server - обычный, полная производительность
resource "yandex_compute_instance" "elasticsearch" {
  name        = var.elasticsearch_name
  platform_id = var.elasticsearch_instance_type
  zone        = "ru-central1-a"
  hostname    = var.elasticsearch_name

  resources {
    cores         = 4
    core_fraction = var.elasticsearch_core_fraction  # 100% полная производительность
    memory        = 8
  }

  # Elasticsearch НЕ должен быть прерываемым!
  scheduling_policy {
    preemptible = var.elasticsearch_preemptible  # false
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 30
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.private_a.id
    nat       = false
    security_group_ids = [yandex_vpc_security_group.elasticsearch_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

# Kibana Server - обычный, базовая производительность
resource "yandex_compute_instance" "kibana" {
  name        = var.kibana_name
  platform_id = var.kibana_instance_type
  zone        = "ru-central1-a"
  hostname    = var.kibana_name

  resources {
    cores         = 2
    core_fraction = var.kibana_core_fraction  # 20% базовая производительность
    memory        = 2
  }

  scheduling_policy {
    preemptible = var.kibana_preemptible  # false
  }

  boot_disk {
    initialize_params {
      image_id = var.ubuntu_image_id
      size     = 10
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.public.id
    nat       = true
    security_group_ids = [yandex_vpc_security_group.kibana_sg.id]
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.ssh_public_key_path)}"
  }
}

=== lb.tf ===
# Target Group for web servers
resource "yandex_lb_target_group" "web" {
  name = "web-target-group"

  target {
    subnet_id  = yandex_vpc_subnet.private_a.id
    address    = yandex_compute_instance.web_1.network_interface.0.ip_address
  }

  target {
    subnet_id  = yandex_vpc_subnet.private_b.id
    address    = yandex_compute_instance.web_2.network_interface.0.ip_address
  }
}

# Network Load Balancer
resource "yandex_lb_network_load_balancer" "web_nlb" {
  name = "web-network-load-balancer"
  type = "external"

  listener {
    name = "web-listener"
    port = 80
    external_address_spec {
      ip_version = "ipv4"
    }
  }

  attached_target_group {
    target_group_id = yandex_lb_target_group.web.id

    healthcheck {
      name                = "http"
      interval            = 2
      timeout             = 1
      unhealthy_threshold = 2
      healthy_threshold   = 2

      http_options {
        port = 80
        path = "/"
      }
    }
  }
}

=== main.tf ===
terraform {
  required_version = ">= 1.0"
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = ">= 0.89"
    }
  }
}

provider "yandex" {
  token     = var.yc_token
  cloud_id  = var.yc_cloud_id
  folder_id = var.yc_folder_id
  zone      = "ru-central1-a"
}

=== outputs.tf ===
output "bastion_public_ip" {
  value       = yandex_compute_instance.bastion.network_interface[0].nat_ip_address
  description = "Public IP address of bastion host"
}

output "load_balancer_ip" {
  value = one([
    for spec in one(yandex_lb_network_load_balancer.web_nlb.listener).external_address_spec : spec.address
  ])
  description = "Public IP address of Network Load Balancer"
}

output "grafana_public_ip" {
  value       = yandex_compute_instance.grafana.network_interface[0].nat_ip_address
  description = "Public IP address of Grafana"
}

output "kibana_public_ip" {
  value       = yandex_compute_instance.kibana.network_interface[0].nat_ip_address
  description = "Public IP address of Kibana"
}

output "web_servers_private_ips" {
  value = {
    web_1 = yandex_compute_instance.web_1.network_interface[0].ip_address
    web_2 = yandex_compute_instance.web_2.network_interface[0].ip_address
  }
  description = "Private IP addresses of web servers"
}

output "prometheus_private_ip" {
  value       = yandex_compute_instance.prometheus.network_interface[0].ip_address
  description = "Private IP address of Prometheus"
}

output "elasticsearch_private_ip" {
  value       = yandex_compute_instance.elasticsearch.network_interface[0].ip_address
  description = "Private IP address of Elasticsearch"
}

=== security-groups.tf ===
# Bastion Security Group
resource "yandex_vpc_security_group" "bastion_sg" {
  name        = "bastion-security-group"
  description = "Security group for bastion host"  
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "SSH from anywhere"
    protocol       = "TCP"
    port           = 22
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Web Servers Security Group
resource "yandex_vpc_security_group" "web_sg" {
  name        = "web-security-group"
  description = "Security group for web servers"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "HTTP from Load Balancer"
    protocol       = "TCP"
    port           = 80
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    description    = "Node Exporter from Prometheus"
    protocol       = "TCP"
    port           = 9100
    security_group_id = yandex_vpc_security_group.prometheus_sg.id
  }

  ingress {
    description    = "Nginx Log Exporter from Prometheus"
    protocol       = "TCP"
    port           = 4040
    security_group_id = yandex_vpc_security_group.prometheus_sg.id
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  # УДАЛИТЕ этот ingress - web серверы НЕ должны принимать входящие подключения на 9200
  # Вместо этого добавьте egress для исходящих подключений
  # ingress {
  #   description    = "Filebeat to Elasticsearch"
  #   protocol       = "TCP"
  #   port           = 9200
  #   security_group_id = yandex_vpc_security_group.elasticsearch_sg.id
  # }

  egress {
    description    = "Filebeat to Elasticsearch"
    protocol       = "TCP"
    port           = 9200
    v4_cidr_blocks = [var.private_subnet_cidr_a]
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Prometheus Security Group
resource "yandex_vpc_security_group" "prometheus_sg" {
  name        = "prometheus-security-group"
  description = "Security group for Prometheus"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Prometheus UI from Grafana"
    protocol       = "TCP"
    port           = 9090
    security_group_id = yandex_vpc_security_group.grafana_sg.id
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Grafana Security Group
resource "yandex_vpc_security_group" "grafana_sg" {
  name        = "grafana-security-group"
  description = "Security group for Grafana"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Grafana UI from anywhere"
    protocol       = "TCP"
    port           = 3000
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Elasticsearch Security Group
resource "yandex_vpc_security_group" "elasticsearch_sg" {
  name        = "elasticsearch-security-group"
  description = "Security group for Elasticsearch"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Elasticsearch API from Kibana"
    protocol       = "TCP"
    port           = 9200
    security_group_id = yandex_vpc_security_group.kibana_sg.id
  }

  # ИЗМЕНИТЕ: вместо security_group_id используйте v4_cidr_blocks
  ingress {
    description    = "Filebeat from Web Servers"
    protocol       = "TCP"
    port           = 9200
    v4_cidr_blocks = [var.private_subnet_cidr_a, var.private_subnet_cidr_b]
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Kibana Security Group
resource "yandex_vpc_security_group" "kibana_sg" {
  name        = "kibana-security-group"
  description = "Security group for Kibana"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "Kibana UI from anywhere"
    protocol       = "TCP"
    port           = 5601
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    description    = "SSH from Bastion"
    protocol       = "TCP"
    port           = 22
    security_group_id = yandex_vpc_security_group.bastion_sg.id
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

# Load Balancer Security Group
resource "yandex_vpc_security_group" "lb_sg" {
  name        = "load-balancer-security-group"
  description = "Security group for Load Balancer"
  network_id  = yandex_vpc_network.main.id

  ingress {
    description    = "HTTP from anywhere"
    protocol       = "TCP"
    port           = 80
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description    = "Allow all outgoing traffic"
    protocol       = "ANY"
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
}

=== terraform.tfstate ===
{
  "version": 4,
  "terraform_version": "1.15.0",
  "serial": 132,
  "lineage": "38277a0c-bbf4-1ff9-407f-e1bcdaf4a6e9",
  "outputs": {
    "bastion_public_ip": {
      "value": "84.201.172.116",
      "type": "string"
    },
    "elasticsearch_private_ip": {
      "value": "10.0.2.35",
      "type": "string"
    },
    "grafana_public_ip": {
      "value": "158.160.45.152",
      "type": "string"
    },
    "kibana_public_ip": {
      "value": "158.160.51.20",
      "type": "string"
    },
    "load_balancer_ip": {
      "value": "158.160.206.182",
      "type": "string"
    },
    "prometheus_private_ip": {
      "value": "10.0.2.32",
      "type": "string"
    },
    "web_servers_private_ips": {
      "value": {
        "web_1": "10.0.2.26",
        "web_2": "10.0.3.9"
      },
      "type": [
        "object",
        {
          "web_1": "string",
          "web_2": "string"
        }
      ]
    }
  },
  "resources": [
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "bastion",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "fhmbh1q90fsc05r4ohos",
                "disk_id": "fhmbh1q90fsc05r4ohos",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 10,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:29Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "bastion.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "bastion",
            "id": "fhmh1old1lpv99dgvfbc",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n",
              "user-data": "#cloud-config\nwrite_files:\n  - path: /etc/sysctl.d/10-ip-forward.conf\n    content: |\n      net.ipv4.ip_forward=1\n      net.ipv6.conf.all.forwarding=1\nruncmd:\n  - sysctl -p /etc/sysctl.d/10-ip-forward.conf\n  - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE\n  - iptables -A FORWARD -i eth0 -o eth0 -j ACCEPT\n  - apt-get update\n  - apt-get install -y iptables-persistent\n  - netfilter-persistent save\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "bastion",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.1.31",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:11:0e:2a:d0",
                "nat": true,
                "nat_dns_record": [],
                "nat_ip_address": "84.201.172.116",
                "nat_ip_version": "IPV4",
                "security_group_ids": [
                  "enpi4tlt9b8n9mcte9ap"
                ],
                "subnet_id": "e9b56bbp3dolpvuatjn0"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 100,
                "cores": 2,
                "gpus": 0,
                "memory": 2
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": false
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_subnet.public"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "elasticsearch",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "fhmiuq7mp2kd736chvji",
                "disk_id": "fhmiuq7mp2kd736chvji",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 30,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:49Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "elasticsearch.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "elasticsearch",
            "id": "fhmvcp9ng3jg55mfv967",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "elasticsearch",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.2.35",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:1f:66:53:78",
                "nat": false,
                "nat_dns_record": [],
                "nat_ip_address": "",
                "nat_ip_version": "",
                "security_group_ids": [
                  "enppmlet8gko2h4l5pcm"
                ],
                "subnet_id": "e9bfdod8u9lbs9ckt02c"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 100,
                "cores": 4,
                "gpus": 0,
                "memory": 8
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": false
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.elasticsearch_sg",
            "yandex_vpc_security_group.kibana_sg",
            "yandex_vpc_subnet.private_a"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "grafana",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "fhm5gm0jeuclvcoh054f",
                "disk_id": "fhm5gm0jeuclvcoh054f",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 10,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:31Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "grafana.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "grafana",
            "id": "fhm2slkcl2gkrjkphj7u",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "grafana",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.1.30",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:2e:56:8c:a8",
                "nat": true,
                "nat_dns_record": [],
                "nat_ip_address": "158.160.45.152",
                "nat_ip_version": "IPV4",
                "security_group_ids": [
                  "enpr31vpe0vqh64m82m0"
                ],
                "subnet_id": "e9b56bbp3dolpvuatjn0"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 20,
                "cores": 2,
                "gpus": 0,
                "memory": 2
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": false
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_subnet.public"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "kibana",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "fhmu1savhunjct3e4v6b",
                "disk_id": "fhmu1savhunjct3e4v6b",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 10,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:44Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "kibana.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "kibana",
            "id": "fhmaemt2v3bdg42m8gr9",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "kibana",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.1.18",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:a7:5b:a2:f8",
                "nat": true,
                "nat_dns_record": [],
                "nat_ip_address": "158.160.51.20",
                "nat_ip_version": "IPV4",
                "security_group_ids": [
                  "enpv6r3nq38l7kngpg6b"
                ],
                "subnet_id": "e9b56bbp3dolpvuatjn0"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 20,
                "cores": 2,
                "gpus": 0,
                "memory": 2
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": false
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.kibana_sg",
            "yandex_vpc_subnet.public"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "prometheus",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "fhm1sr3be9d0s795mddn",
                "disk_id": "fhm1sr3be9d0s795mddn",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 10,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:34Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "prometheus.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "prometheus",
            "id": "fhma1rfp418e87mujnii",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "prometheus",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.2.32",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:a0:ed:f9:20",
                "nat": false,
                "nat_dns_record": [],
                "nat_ip_address": "",
                "nat_ip_version": "",
                "security_group_ids": [
                  "enppii4stg4jea6vrn32"
                ],
                "subnet_id": "e9bfdod8u9lbs9ckt02c"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 50,
                "cores": 2,
                "gpus": 0,
                "memory": 2
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": false
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.prometheus_sg",
            "yandex_vpc_subnet.private_a"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "web_1",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "fhm2hgkjfmkehlegppo8",
                "disk_id": "fhm2hgkjfmkehlegppo8",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 10,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:36Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "web-1.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "web-1",
            "id": "fhmbd3tkcc7bvnpt05td",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "web-1",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.2.26",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:b6:8f:b4:63",
                "nat": false,
                "nat_dns_record": [],
                "nat_ip_address": "",
                "nat_ip_version": "",
                "security_group_ids": [
                  "enpk4umrjors3bv06aui"
                ],
                "subnet_id": "e9bfdod8u9lbs9ckt02c"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 5,
                "cores": 2,
                "gpus": 0,
                "memory": 2
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": true
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.prometheus_sg",
            "yandex_vpc_security_group.web_sg",
            "yandex_vpc_subnet.private_a"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_instance",
      "name": "web_2",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "allow_recreate": null,
            "allow_stopping_for_update": null,
            "boot_disk": [
              {
                "auto_delete": true,
                "device_name": "epd6b4976kqsi0thi2s3",
                "disk_id": "epd6b4976kqsi0thi2s3",
                "initialize_params": [
                  {
                    "block_size": 4096,
                    "description": "",
                    "image_id": "fd804teg9bthv0h96s8v",
                    "kms_key_id": "",
                    "name": "",
                    "size": 10,
                    "snapshot_id": "",
                    "type": "network-hdd"
                  }
                ],
                "mode": "READ_WRITE"
              }
            ],
            "created_at": "2026-01-22T10:11:36Z",
            "description": "",
            "filesystem": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "fqdn": "web-2.ru-central1.internal",
            "gpu_cluster_id": "",
            "hardware_generation": [
              {
                "generation2_features": [],
                "legacy_features": [
                  {
                    "pci_topology": "PCI_TOPOLOGY_V2"
                  }
                ]
              }
            ],
            "hostname": "web-2",
            "id": "epdr77a1c47cjn8ttq3e",
            "labels": null,
            "local_disk": [],
            "maintenance_grace_period": "",
            "maintenance_policy": null,
            "metadata": {
              "ssh-keys": "ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDegwZonFVREXYICWo6zeeukE1i3edFLA/Xci4glG2YzM6a0N7CHA/qjfS5IRs5phCQDsQqFK40tDhzANUi8DMQk/7zBdFqNZ2o6NpYWie/bK5FIzmOlHmgx1szEQj6Tn88d/zo+EBdqiZ+oPAUR0vnyBW69Wj5AG15f3+xNV+0H52u/Q9lqbJ+TkYOxhmdo2q/seLZARL8mrdgxO7EBQs4q45P0yXpxinJHpW7c5Pq70cBCsmN5IdFmCCjZA92d1tqKxu/Qr3KFfc3fhr5ngcs4+XnlbY7V1Q6IB9NDf+XZMsyb3YicRvFf0GSkWPekwjWi6UzoX13vjrjZPIFGt3R root@test-netology\n"
            },
            "metadata_options": [
              {
                "aws_v1_http_endpoint": 1,
                "aws_v1_http_token": 2,
                "gce_http_endpoint": 1,
                "gce_http_token": 1
              }
            ],
            "name": "web-2",
            "network_acceleration_type": "standard",
            "network_interface": [
              {
                "dns_record": [],
                "index": 0,
                "ip_address": "10.0.3.9",
                "ipv4": true,
                "ipv6": false,
                "ipv6_address": "",
                "ipv6_dns_record": [],
                "mac_address": "d0:0d:1b:39:d4:16",
                "nat": false,
                "nat_dns_record": [],
                "nat_ip_address": "",
                "nat_ip_version": "",
                "security_group_ids": [
                  "enpk4umrjors3bv06aui"
                ],
                "subnet_id": "e2lvfhqth9ea8qtg56o8"
              }
            ],
            "placement_policy": [
              {
                "host_affinity_rules": [],
                "placement_group_id": "",
                "placement_group_partition": 0
              }
            ],
            "platform_id": "standard-v2",
            "resources": [
              {
                "core_fraction": 5,
                "cores": 2,
                "gpus": 0,
                "memory": 2
              }
            ],
            "scheduling_policy": [
              {
                "preemptible": true
              }
            ],
            "secondary_disk": [],
            "service_account_id": "",
            "status": "running",
            "timeouts": null,
            "zone": "ru-central1-b"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH0sInNjaGVtYV92ZXJzaW9uIjoiMSJ9",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.prometheus_sg",
            "yandex_vpc_security_group.web_sg",
            "yandex_vpc_subnet.private_b"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_compute_snapshot_schedule",
      "name": "daily_backup",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:12:28Z",
            "description": "",
            "disk_ids": [
              "epd6b4976kqsi0thi2s3",
              "fhm1sr3be9d0s795mddn",
              "fhm2hgkjfmkehlegppo8",
              "fhm5gm0jeuclvcoh054f",
              "fhmbh1q90fsc05r4ohos",
              "fhmiuq7mp2kd736chvji",
              "fhmu1savhunjct3e4v6b"
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "fd8ddcrkoj10vbm0ol8e",
            "labels": null,
            "name": "daily-backup-schedule",
            "retention_period": "",
            "schedule_policy": [
              {
                "expression": "0 2 * * *",
                "start_at": "1970-01-01T00:00:00Z"
              }
            ],
            "snapshot_count": 7,
            "snapshot_spec": [
              {
                "description": "Daily backup",
                "labels": null
              }
            ],
            "status": "active",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_compute_instance.bastion",
            "yandex_compute_instance.elasticsearch",
            "yandex_compute_instance.grafana",
            "yandex_compute_instance.kibana",
            "yandex_compute_instance.prometheus",
            "yandex_compute_instance.web_1",
            "yandex_compute_instance.web_2",
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.elasticsearch_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.kibana_sg",
            "yandex_vpc_security_group.prometheus_sg",
            "yandex_vpc_security_group.web_sg",
            "yandex_vpc_subnet.private_a",
            "yandex_vpc_subnet.private_b",
            "yandex_vpc_subnet.public"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_lb_network_load_balancer",
      "name": "web_nlb",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "allow_zonal_shift": false,
            "attached_target_group": [
              {
                "healthcheck": [
                  {
                    "healthy_threshold": 2,
                    "http_options": [
                      {
                        "path": "/",
                        "port": 80
                      }
                    ],
                    "interval": 2,
                    "name": "http",
                    "tcp_options": [],
                    "timeout": 1,
                    "unhealthy_threshold": 2
                  }
                ],
                "target_group_id": "enp2po4297fi8froh3go"
              }
            ],
            "created_at": "2026-01-22T10:12:20Z",
            "deletion_protection": false,
            "description": "",
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enp08adr3p39qd4ueud1",
            "labels": null,
            "listener": [
              {
                "external_address_spec": [
                  {
                    "address": "158.160.206.182",
                    "ip_version": "ipv4"
                  }
                ],
                "internal_address_spec": [],
                "name": "web-listener",
                "port": 80,
                "protocol": "tcp",
                "target_port": 80
              }
            ],
            "name": "web-network-load-balancer",
            "region_id": "ru-central1",
            "timeouts": null,
            "type": "external"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsImRlbGV0ZSI6MzAwMDAwMDAwMDAwLCJ1cGRhdGUiOjMwMDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_compute_instance.web_1",
            "yandex_compute_instance.web_2",
            "yandex_lb_target_group.web",
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.prometheus_sg",
            "yandex_vpc_security_group.web_sg",
            "yandex_vpc_subnet.private_a",
            "yandex_vpc_subnet.private_b"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_lb_target_group",
      "name": "web",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "created_at": "2026-01-22T10:12:18Z",
            "description": "",
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enp2po4297fi8froh3go",
            "labels": null,
            "name": "web-target-group",
            "region_id": "ru-central1",
            "target": [
              {
                "address": "10.0.2.26",
                "subnet_id": "e9bfdod8u9lbs9ckt02c"
              },
              {
                "address": "10.0.3.9",
                "subnet_id": "e2lvfhqth9ea8qtg56o8"
              }
            ],
            "target_group_id": "enp2po4297fi8froh3go",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "dependencies": [
            "yandex_compute_instance.web_1",
            "yandex_compute_instance.web_2",
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.prometheus_sg",
            "yandex_vpc_security_group.web_sg",
            "yandex_vpc_subnet.private_a",
            "yandex_vpc_subnet.private_b"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_gateway",
      "name": "nat_gateway",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:22Z",
            "description": "",
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpkq1tnsivp2bd2j82l",
            "labels": {},
            "name": "nat-gateway",
            "shared_egress_gateway": [
              {}
            ],
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMCwiZGVsZXRlIjo2MDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMH19"
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_network",
      "name": "main",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:22Z",
            "default_security_group_id": "enpvvaegakfg02cj3l0c",
            "description": "",
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpqdk48togvpmkdn6ul",
            "labels": {},
            "name": "infra-project-vpc",
            "subnet_ids": [],
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMCwiZGVsZXRlIjo2MDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMH19"
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_route_table",
      "name": "nat",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:25Z",
            "description": "",
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpr87tmnc9s2f4m3t02",
            "labels": {},
            "name": "nat-route-table",
            "network_id": "enpqdk48togvpmkdn6ul",
            "static_route": [
              {
                "destination_prefix": "0.0.0.0/0",
                "gateway_id": "enpkq1tnsivp2bd2j82l",
                "next_hop_address": ""
              }
            ],
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "bastion_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:29Z",
            "description": "Security group for bastion host",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enpvbmsis2v3eb9vjort",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpi4tlt9b8n9mcte9ap",
            "ingress": [
              {
                "description": "SSH from anywhere",
                "from_port": -1,
                "id": "enptlfevo41tt392m1oe",
                "labels": {},
                "port": 22,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "bastion-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "elasticsearch_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:48Z",
            "description": "Security group for Elasticsearch",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enpcbpvc6bghe6nks2k5",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enppmlet8gko2h4l5pcm",
            "ingress": [
              {
                "description": "Elasticsearch API from Kibana",
                "from_port": -1,
                "id": "enpn9gf8o2n1anfc3bs0",
                "labels": {},
                "port": 9200,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpv6r3nq38l7kngpg6b",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              },
              {
                "description": "Filebeat from Web Servers",
                "from_port": -1,
                "id": "enps9mag1a81gbg3eq4d",
                "labels": {},
                "port": 9200,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "10.0.2.0/24",
                  "10.0.3.0/24"
                ],
                "v6_cidr_blocks": []
              },
              {
                "description": "SSH from Bastion",
                "from_port": -1,
                "id": "enp821ur9a6g1f17rvn1",
                "labels": {},
                "port": 22,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpi4tlt9b8n9mcte9ap",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "elasticsearch-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.kibana_sg"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "grafana_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:31Z",
            "description": "Security group for Grafana",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enp77cc0tjdh05r451vd",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpr31vpe0vqh64m82m0",
            "ingress": [
              {
                "description": "Grafana UI from anywhere",
                "from_port": -1,
                "id": "enp41df2a0bhgeacmq10",
                "labels": {},
                "port": 3000,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              },
              {
                "description": "SSH from Bastion",
                "from_port": -1,
                "id": "enpmmphic2nv1modq98d",
                "labels": {},
                "port": 22,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpi4tlt9b8n9mcte9ap",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "grafana-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "kibana_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:42Z",
            "description": "Security group for Kibana",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enpp9le42hnp8eu2pmdi",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpv6r3nq38l7kngpg6b",
            "ingress": [
              {
                "description": "Kibana UI from anywhere",
                "from_port": -1,
                "id": "enpo8uqbv3v8kpem79gt",
                "labels": {},
                "port": 5601,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              },
              {
                "description": "SSH from Bastion",
                "from_port": -1,
                "id": "enpcoraenkt0ntim1plm",
                "labels": {},
                "port": 22,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpi4tlt9b8n9mcte9ap",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "kibana-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "lb_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:26Z",
            "description": "Security group for Load Balancer",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enpppl3n0o3foup9u2et",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enp7lon28upl5bu740l7",
            "ingress": [
              {
                "description": "HTTP from anywhere",
                "from_port": -1,
                "id": "enpbeaf2rujerob92lrt",
                "labels": {},
                "port": 80,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "load-balancer-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "prometheus_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:33Z",
            "description": "Security group for Prometheus",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enpf84do8gg2kjepr1vq",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enppii4stg4jea6vrn32",
            "ingress": [
              {
                "description": "Prometheus UI from Grafana",
                "from_port": -1,
                "id": "enpksfd7drrq7ees7hs3",
                "labels": {},
                "port": 9090,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpr31vpe0vqh64m82m0",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              },
              {
                "description": "SSH from Bastion",
                "from_port": -1,
                "id": "enpfjcl9usltec3a99ml",
                "labels": {},
                "port": 22,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpi4tlt9b8n9mcte9ap",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "prometheus-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_security_group",
      "name": "web_sg",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:35Z",
            "description": "Security group for web servers",
            "egress": [
              {
                "description": "Allow all outgoing traffic",
                "from_port": -1,
                "id": "enpuesnk1sof21eblru3",
                "labels": {},
                "port": -1,
                "predefined_target": "",
                "protocol": "ANY",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              },
              {
                "description": "Filebeat to Elasticsearch",
                "from_port": -1,
                "id": "enpqujnojimfklbtna33",
                "labels": {},
                "port": 9200,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "10.0.2.0/24"
                ],
                "v6_cidr_blocks": []
              }
            ],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "enpk4umrjors3bv06aui",
            "ingress": [
              {
                "description": "HTTP from Load Balancer",
                "from_port": -1,
                "id": "enplg67tbdn7intqquva",
                "labels": {},
                "port": 80,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "",
                "to_port": -1,
                "v4_cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "v6_cidr_blocks": []
              },
              {
                "description": "Nginx Log Exporter from Prometheus",
                "from_port": -1,
                "id": "enp76et63ms23st2ri4i",
                "labels": {},
                "port": 4040,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enppii4stg4jea6vrn32",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              },
              {
                "description": "Node Exporter from Prometheus",
                "from_port": -1,
                "id": "enpuomr2ki2gg0cotn59",
                "labels": {},
                "port": 9100,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enppii4stg4jea6vrn32",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              },
              {
                "description": "SSH from Bastion",
                "from_port": -1,
                "id": "enpe7ufmgaf6nl7g7vsi",
                "labels": {},
                "port": 22,
                "predefined_target": "",
                "protocol": "TCP",
                "security_group_id": "enpi4tlt9b8n9mcte9ap",
                "to_port": -1,
                "v4_cidr_blocks": [],
                "v6_cidr_blocks": []
              }
            ],
            "labels": {},
            "name": "web-security-group",
            "network_id": "enpqdk48togvpmkdn6ul",
            "status": "ACTIVE",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main",
            "yandex_vpc_security_group.bastion_sg",
            "yandex_vpc_security_group.grafana_sg",
            "yandex_vpc_security_group.prometheus_sg"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_subnet",
      "name": "private_a",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:27Z",
            "description": "",
            "dhcp_options": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "e9bfdod8u9lbs9ckt02c",
            "labels": {},
            "name": "private-subnet-a",
            "network_id": "enpqdk48togvpmkdn6ul",
            "route_table_id": "enpr87tmnc9s2f4m3t02",
            "timeouts": null,
            "v4_cidr_blocks": [
              "10.0.2.0/24"
            ],
            "v6_cidr_blocks": [],
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_subnet",
      "name": "private_b",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:27Z",
            "description": "",
            "dhcp_options": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "e2lvfhqth9ea8qtg56o8",
            "labels": {},
            "name": "private-subnet-b",
            "network_id": "enpqdk48togvpmkdn6ul",
            "route_table_id": "enpr87tmnc9s2f4m3t02",
            "timeouts": null,
            "v4_cidr_blocks": [
              "10.0.3.0/24"
            ],
            "v6_cidr_blocks": [],
            "zone": "ru-central1-b"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_gateway.nat_gateway",
            "yandex_vpc_network.main",
            "yandex_vpc_route_table.nat"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "yandex_vpc_subnet",
      "name": "public",
      "provider": "provider[\"registry.terraform.io/yandex-cloud/yandex\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created_at": "2026-01-22T10:11:25Z",
            "description": "",
            "dhcp_options": [],
            "folder_id": "b1gfp2upthkrdnmq1ec6",
            "id": "e9b56bbp3dolpvuatjn0",
            "labels": {},
            "name": "public-subnet",
            "network_id": "enpqdk48togvpmkdn6ul",
            "route_table_id": "",
            "timeouts": null,
            "v4_cidr_blocks": [
              "10.0.1.0/24"
            ],
            "v6_cidr_blocks": [],
            "zone": "ru-central1-a"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAsImRlbGV0ZSI6MTgwMDAwMDAwMDAwLCJ1cGRhdGUiOjE4MDAwMDAwMDAwMH19",
          "dependencies": [
            "yandex_vpc_network.main"
          ]
        }
      ]
    }
  ],
  "check_results": null
}

=== terraform.tfstate.backup ===
{
  "version": 4,
  "terraform_version": "1.15.0",
  "serial": 108,
  "lineage": "38277a0c-bbf4-1ff9-407f-e1bcdaf4a6e9",
  "outputs": {},
  "resources": [],
  "check_results": null
}

=== terraform.tfvars ===
yc_token     = "y0__xDO_-KHARjB3RMgs9mvjxX_eodN3v_ehWY42iDNoc5Y9lW4pQ"
yc_cloud_id  = "b1gjjh2hn4jua82aoab8"
yc_folder_id = "b1gfp2upthkrdnmq1ec6"

=== variables.tf ===
# variables.tf

# Yandex Cloud credentials
variable "yc_token" {
  type        = string
  sensitive   = true
  description = "Yandex Cloud OAuth token"
}

variable "yc_cloud_id" {
  type        = string
  description = "Yandex Cloud ID"
}

variable "yc_folder_id" {
  type        = string
  description = "Yandex Cloud folder ID"
}

# SSH and Image
variable "ssh_public_key_path" {
  type        = string
  default     = "~/.ssh/id_rsa.pub"
  description = "Path to SSH public key"
}

variable "ubuntu_image_id" {
  type        = string
  default     = "fd804teg9bthv0h96s8v"  # Ubuntu 22.04 LTS
  description = "Ubuntu 22.04 LTS image ID"
}

# Network variables
variable "vpc_cidr" {
  type        = string
  default     = "10.0.0.0/16"
  description = "VPC CIDR block"
}

variable "public_subnet_cidr" {
  type        = string
  default     = "10.0.1.0/24"
  description = "Public subnet CIDR"
}

variable "private_subnet_cidr_a" {
  type        = string
  default     = "10.0.2.0/24"
  description = "Private subnet A CIDR"
}

variable "private_subnet_cidr_b" {
  type        = string
  default     = "10.0.3.0/24"
  description = "Private subnet B CIDR"
}

# Instance names
variable "bastion_name" {
  type        = string
  default     = "bastion"
  description = "Bastion host name"
}

variable "webserver_names" {
  type        = list(string)
  default     = ["web-1", "web-2"]
  description = "Web server names"
}

variable "prometheus_name" {
  type        = string
  default     = "prometheus"
  description = "Prometheus server name"
}

variable "grafana_name" {
  type        = string
  default     = "grafana"
  description = "Grafana server name"
}

variable "elasticsearch_name" {
  type        = string
  default     = "elasticsearch"
  description = "Elasticsearch server name"
}

variable "kibana_name" {
  type        = string
  default     = "kibana"
  description = "Kibana server name"
}

# Instance types
variable "bastion_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Bastion instance type"
}

variable "web_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Web server instance type"
}

variable "prometheus_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Prometheus instance type"
}

variable "grafana_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Grafana instance type"
}

variable "elasticsearch_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Elasticsearch instance type"
}

variable "kibana_instance_type" {
  type        = string
  default     = "standard-v2"
  description = "Kibana instance type"
}

# vCPU Core fractions (5, 20, 50, 100)
variable "bastion_core_fraction" {
  type        = number
  default     = 100
  description = "Bastion vCPU fraction (5, 20, 50, 100)"
}

variable "web_core_fraction" {
  type        = number
  default     = 5
  description = "Web servers vCPU fraction (5, 20, 50, 100)"
}

variable "prometheus_core_fraction" {
  type        = number
  default     = 50
  description = "Prometheus vCPU fraction (5, 20, 50, 100)"
}

variable "grafana_core_fraction" {
  type        = number
  default     = 20
  description = "Grafana vCPU fraction (5, 20, 50, 100)"
}

variable "elasticsearch_core_fraction" {
  type        = number
  default     = 100
  description = "Elasticsearch vCPU fraction (5, 20, 50, 100)"
}

variable "kibana_core_fraction" {
  type        = number
  default     = 20
  description = "Kibana vCPU fraction (5, 20, 50, 100)"
}

# Preemptible instances flags
variable "web_preemptible" {
  type        = bool
  default     = true
  description = "Make web servers preemptible (spot instances)"
}

variable "prometheus_preemptible" {
  type        = bool
  default     = false
  description = "Make Prometheus preemptible"
}

variable "grafana_preemptible" {
  type        = bool
  default     = false
  description = "Make Grafana preemptible"
}

variable "elasticsearch_preemptible" {
  type        = bool
  default     = false
  description = "Make Elasticsearch preemptible"
}

variable "kibana_preemptible" {
  type        = bool
  default     = false
  description = "Make Kibana preemptible"
}

=== vpc.tf ===
# VPC
resource "yandex_vpc_network" "main" {
  name = "infra-project-vpc"
}

# Public subnet
resource "yandex_vpc_subnet" "public" {
  name           = "public-subnet"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main.id
  v4_cidr_blocks = [var.public_subnet_cidr]
}

# Private subnet A
resource "yandex_vpc_subnet" "private_a" {
  name           = "private-subnet-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main.id
  v4_cidr_blocks = [var.private_subnet_cidr_a]
  route_table_id = yandex_vpc_route_table.nat.id
}

# Private subnet B
resource "yandex_vpc_subnet" "private_b" {
  name           = "private-subnet-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.main.id
  v4_cidr_blocks = [var.private_subnet_cidr_b]
  route_table_id = yandex_vpc_route_table.nat.id
}

# NAT Gateway
resource "yandex_vpc_gateway" "nat_gateway" {
  name = "nat-gateway"
  shared_egress_gateway {}
}

# Route table for NAT
resource "yandex_vpc_route_table" "nat" {
  name       = "nat-route-table"
  network_id = yandex_vpc_network.main.id

  static_route {
    destination_prefix = "0.0.0.0/0"
    gateway_id         = yandex_vpc_gateway.nat_gateway.id
  }
}

