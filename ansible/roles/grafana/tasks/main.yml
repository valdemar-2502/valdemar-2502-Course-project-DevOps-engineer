---
- name: Download Grafana package
  get_url:
    url: "{{ grafana_deb_url }}"
    dest: /tmp/grafana.deb
    mode: '0644'

- name: Install Grafana
  apt:
    deb: /tmp/grafana.deb

- name: Configure Grafana
  template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
  notify: restart grafana

- name: Enable and start Grafana
  systemd:
    name: grafana-server
    enabled: yes
    state: started

- name: Wait for Grafana to start
  wait_for:
    port: 3000
    delay: 10
    timeout: 60

- name: Configure Grafana datasources via API
  uri:
    url: "http://localhost:3000/api/datasources"
    method: POST
    user: admin
    password: admin123
    force_basic_auth: yes
    body_format: json
    body:
      name: "Prometheus"
      type: "prometheus"
      access: "proxy"
      url: "http://{{ prometheus_ip | default('10.0.2.32') }}:9090"
      isDefault: true
    status_code: 200
  register: datasource_result
  failed_when: false

- debug:
    msg: "Grafana datasource configured: {{ datasource_result.status }}"

- name: Import Grafana dashboards
  uri:
    url: "http://localhost:3000/api/dashboards/db"
    method: POST
    user: admin
    password: admin123
    force_basic_auth: yes
    body_format: json
    body:
      dashboard: "{{ lookup('url', 'https://grafana.com/api/dashboards/1860/revisions/22/download', split_lines=False) | from_json }}"
      overwrite: true
    status_code: 200
  register: dashboard_result
  failed_when: false

- debug:
    msg: "Grafana dashboard imported: {{ dashboard_result.status }}"
