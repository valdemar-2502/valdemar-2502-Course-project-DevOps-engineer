---
- name: Wait for apt to be unlocked
  shell: |
    timeout 300 bash -c 'while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done'
  become: yes
  register: apt_wait
  until: apt_wait.rc == 0
  retries: 10
  delay: 30
  ignore_errors: yes

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install basic packages
  apt:
    name:
      - curl
      - wget
      - gnupg
      - software-properties-common
      - apt-transport-https
      - ca-certificates
      - net-tools
      - htop
      - iotop
      - iftop
      - jq
      - python3-pip
    state: present

- name: Set timezone
  timezone:
    name: "{{ timezone }}"

- name: Configure NTP
  copy:
    dest: /etc/systemd/timesyncd.conf
    content: |
      [Time]
      NTP={{ ntp_servers | join(' ') }}
      FallbackNTP=ntp.ubuntu.com
  notify: restart systemd-timesyncd

- name: Enable and start systemd-timesyncd
  systemd:
    name: systemd-timesyncd
    enabled: yes
    state: started

- name: Create admin user
  user:
    name: "{{ admin_user }}"
    groups: sudo
    append: yes
    shell: /bin/bash

- name: Set up SSH authorized keys for admin
  authorized_key:
    user: "{{ admin_user }}"
    state: present
    key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_rsa.pub') }}"

- name: Configure SSH to prevent root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
  notify: restart ssh

- name: Configure SSH to use key authentication only
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication'
    line: 'PasswordAuthentication no'
  notify: restart ssh
