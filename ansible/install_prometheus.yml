---
- name: Install Prometheus manually
  hosts: prometheus
  become: yes
  tasks:
    - name: Install Prometheus from apt (simplified)
      apt:
        name: prometheus
        state: present
        update_cache: yes

    - name: Configure Prometheus
      copy:
        dest: /etc/prometheus/prometheus.yml
        content: |
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            - job_name: 'node'
              static_configs:
                - targets:
                    - '10.0.2.26:9100'
                    - '10.0.3.9:9100'
                    - 'localhost:9100'
                    - '10.0.2.35:9100'
                    - '158.160.102.192:9100'
                    - '89.169.144.143:9100'

            - job_name: 'nginx'
              static_configs:
                - targets:
                    - '10.0.2.26:4040'
                    - '10.0.3.9:4040'
        owner: prometheus
        group: prometheus
        mode: '0644'

    - name: Restart Prometheus
      systemd:
        name: prometheus
        state: restarted
        enabled: yes

    - name: Check Prometheus status
      shell: |
        sleep 5
        curl -s http://localhost:9090/-/ready
      register: prometheus_status
      failed_when: false

    - debug:
        msg: "Prometheus status: {{ prometheus_status.stdout }}"
